---
title: "ISLR Exercises Chapter 4"
author: "Yigit Ozan Berk"
date: "10/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
 
# 4.6 Lab

Smarket data from ISLR library
```{r}
library(ISLR)
data = Smarket
```

Time series data.

Percentage returns for the S&P 500 stock index over 1,250 days, from the beginning of 2001 until the end of 2005.

For each date, the percentage returns for each of the five previous trading days are recorded.(daily)

Also recorded variables:
Volume : the number of shares traded on the previous day, in billions.
Today : the percentage return on the date in question
Direction : whether the market was Up or Down on this date.


```{r}
str(data)
```

```{r}
cor(data[, -9])
```

Correlation between the lag variables and today's returns are close to zero. In other words, there appears to be little correlation between today's returns and previous days' returns. the only substantial correlation is between Year and Volume. 

```{r}
plot(Smarket$Volume)
```

volume is increasing over time. The average number os shares traded daily increased from 2001 to 2005.

## Logistic Regression

logistic regression model to predict Direction using lag1 through lag5 and volume. 
```{r}
glm.fits = glm(Direction ~ Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + Volume, data = Smarket, family = binomial)
summary(glm.fits)
```

smallest p-value is associated with lag1. however, at a value of 0.15, there is no clear evidence of a real association between lag1 and direction.

```{r}
coef(glm.fits)
```

```{r}
summary(glm.fits)$coef
```

using the predict function:
type = "response" option tells R to output probabilities of the form P(Y = 1|X), as opposed to other information such as the logit. 

If no data set is supplied to the predict() function, then the probabilities are computed for the training data that was used to fit the logistic regression model.



```{r}
glm.probs = predict(glm.fits, type = "response")
glm.probs[1:10]
```

These values correspond to the probability of the market going up, rather than down, because the contrasts() function indicates that R has created a dummy variable with a 1 for Up.

```{r}
contrasts(Direction)
```

In order to make a prediction as to whether the market will go up or down on a particular day, we must convert these predicted probabilities into class labels, Up or Down. The following two commands create a vector of class predictions based on whether the predicted probability of a market increase is greater than or less than 0.5.

```{r}
glm.pred = rep("Down", 1250)
#creates a vector of 1250 Down elements
glm.pred[glm.probs > .5] = "Up"
#transforms to Up all of the elements for which the predicted probability of a market increase exceeds 0.5
```

```{r}
table(glm.pred, Direction)
```

```{r}
(507 + 145) / 1250
mean(glm.pred == Direction)
```

At first glance, it appears that logistic regression model is working a little better than random guessing. But,
This is the *training* error rate. 100 - 52.2 == 47.8 %

we can fit the model using part of the data, and then examine how well it predicts the held out data.

```{r}
train= (Year < 2005)
Smarket.2005 = Smarket[!train,]
dim(Smarket.2005)
Direction.2005 = Direction[!train]
```

fit a logistic regression model using only the subset of the observations that correspond to the dates before 2005, using the *subset* argument
```{r}
glm.fits1 = glm(Direction ~ Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + Volume, data = Smarket, family = binomial, subset = train)
glm.probs = predict(glm.fits1 , Smarket.2005, type = "response")
```

```{r}
glm.pred = rep("Down", 252)
#Smarket.2005 has 252 observations
glm.pred[glm.probs > .5] = "Up"
table(glm.pred, Direction.2005)
mean(glm.pred == Direction.2005)
```

The test error rate is 52%, which is worse than random guessing!

Perhaps removing the variables that appear not to be helpful(low p-values) can make the model more effective.

Below we have refit the logistice regression using just Lag1 and Lag2, which seemed to have the highest predictive power in the original logistic regression model

```{r}
glm.fits2 = glm(Direction ~ Lag1 + Lag2, data = Smarket, family = binomial, subset = train)
glm.probs = predict(glm.fits2, Smarket.2005, type = "response")
glm.pred = rep("Down", 252)
glm.pred[glm.probs > .5] = "Up"
table(glm.pred, Direction.2005)
mean(glm.pred == Direction.2005)

```

```{r}
106/(106 + 76)
```

